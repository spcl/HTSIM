# Overview

UEC htsim is based on the open source htsim Network simulator.

## htsim Network Simulator

htsim is a high-performance discrete event simulator, inspired by ns2, but much faster, primarily intended to examine congestion control algorithm behaviour.  It was originally written by [Mark Handley](http://www0.cs.ucl.ac.uk/staff/M.Handley/) to allow [Damon Wishik](https://www.cl.cam.ac.uk/~djw1005/) to examine TCP stability issues when large numbers of flows are multiplexed.  It was extended by [Costin Raiciu](http://nets.cs.pub.ro/~costin/) to examine [Multipath TCP performance](http://nets.cs.pub.ro/~costin/files/mptcp-nsdi.pdf) during the MPTCP standardization process, and models of datacentre networks were added to [examine multipath transport](http://nets.cs.pub.ro/~costin/files/mptcp_dc_sigcomm.pdf) in a variety of datacentre topologies.  [NDP](http://nets.cs.pub.ro/~costin/files/ndp.pdf) was developed using htsim, and simple models of DCTCP, DCQCN were added for comparison.  Later htsim was adopted by Correct Networks (now part of Broadcom) to develop [EQDS](http://nets.cs.pub.ro/~costin/files/eqds.pdf), and switch models were improved to allow a variety of forwarding methods.  Support for a simple RoCE model, PFC, Swift and HPCC were added.

# Getting Started

htsim is written in C++, and has no major dependencies.  
It should compile and run with g++ or clang on MacOS or Linux.  

To get started with running experiments, take a look in the `htsim/sim/datacenter` directory where there are some examples.  
These examples generally require bash, python3 and gnuplot.


## Building the project

Install the Python requirements by running:

```bash
pip install -r requirements.txt
```

Then compile the project from the `sim/` folder by running

```bash
cmake -S . -B build # To configure the cmake project
cmake --build build --parallel # To build the project
```

## Run Validations

From the `sim/datacenter/validation` folder, run:

```bash
python validate_all.py --config_json_file example_validate.json > out.txt
```

Consider modifying the JSON file for more details.

The results will be saved in `sim/datacenter/validation/experiments`. There, each folder will contain a summary plot and a `tmp` folder where more details are stored.

Note that running this can take a long time depending on the chosen configuration.


The commit check validation suite is implemented in `sim/datacenter/commit_check.sh`.
By default, it runs a set of tests at 100Gbps speeds.

Validation workload files with different speeds and configurations can be generated by using the `sim/datacenter/generate_permutation_experiments.py` script:

```bash
python3 generate_permutation_experiments.py 800 NSCC > nscc_800gbps_test.txt
```

# Run Custom Scenarios

The UEC simulation binary is called `htsim_uec` and is located in `sim/datacenter/htsim_uec`.
To run a custom setup, a traffic/connection matrix must be provided.
Examples can be found in `sim/datacenter/connection_matrices`.

You can run a single network connection using UEC CMS as follows:

```bash
./htsim_uec -tm connection_matrices/one.cm
```

The output consists of two major parts: the configuration and setup section, and the runtime section.
The first part of the output shows the configured/derived/default parameter settings and values used by htsim.
It is important to verify that all the parameters are indeed accepted as expected when using custom configurations.
The section part of the output starts with the `Starting simulation` line and displays per flow information.

```
Starting simulation
Flow Uec_0_13 flowId 1000000001 uecSrc 0 starting at 0
Flow Uec_0_13 flowId 1000000001 uecSrc 0 finished at 176.2 total messages 1 total packets 490 RTS 0 total bytes 2002140 in_flight now 0 fair_inc 0 prop_inc 15978 fast_inc 519430 eta_inc 9321 multi_dec -0 quick_dec -0 nack_dec -0
.Done
New: 490 Rtx: 0 RTS: 0 Bounced: 0 ACKs: 124 NACKs: 0 Pulls: 0 sleek_pkts: 0
```

In this specific example, it displays the single flow's start and end information, including the flow completion time and details on the specific congestion control mechanism used.
The last line shows a summary of the run, starting with the total number of packets sent, retransmissions, control messages, ACKs, etc.

To get more details, the `-debug` flag increases the output and shows more details on the active congestion control mechanism.


A second important, but optional parameter is the topology specification. 
At this point, only fat tree topologies are actively developed and maintained.

If no topology-related parameters are provided, htsim uses default parameter values to create one.
Custom parameters can be provided as command line parameters or through topology files. 
The latter are the preferred method.

Here is an example:

```bash
./htsim_uec -tm connection_matrices/perm_32n_32c_2MB.cm -topo topologies/leaf_spine_tiny.topo
```

The `datacenter/topologies` folder contains a set of examples.


## Default Parameters

If no parameters are provided, the defaults aim to follow the UEC specification defaults where it makes sense:

- congestion control mechanism: NSCC
  - Key parameters for NSCC such as network RTT, BDP, etc. are automatically derived
- topology: 3-tier fat tree, 12us RTT
- link speed: 100Gbps
- packet trimming is enabled


# Repository

The repository layout is as follows:

- `sim` the main congestion control simulation files
- `sim/datacenter` simulation scenarios, topologies, binaries, and validation scripts
- `sim/datacenter/connection_matrices` collection of connection matrices used by the validation scripts as well as Python scripts to generate them
- `sim/datacenter/topologies` collection of connection matrices used by the validation scripts

In addition to the UEC congestion management code, the repository contains a wide range of other network protocols.
These are currently not maintained and there is no expectation for any of them to work correctly or at all.


# Development

The UEC continues to use htsim for its standards development needs. 
This public repository aims to enable the public to evaluate and investigate UEC's congestion control mechanisms.
Bug fixes and related discussions are welcome in the public repository.

Before creating PRs, please run `sim/datacenter/commit_check.sh` and include its results in the PR.

To enable the tests (will pull `googletest` as a dependency), run
```bash
cmake -S . -B build -DENABLE_TESTS=ON
cmake --build build --parallel # To build the project
cd build
ctest
```

